# xbernetes
一个可以在AWS上跨Region跨账户的API Server。

# 背景
随着工具链和生态的壮大，Kubernetes已经从一个容器编排系统发展成为了一个流行的分布式系统框架。
开发者可以高效地构建自己的controller将reconcile一个CR(自定义资源)的逻辑封装在其中。
随着Kubernetes社区的发展壮大，很多软件在交付的时候会选择实现一个operator用来做自动化运维。
而operator的实质就是订阅Kubernetes的API server，监视一些特定CR的相关时间并作出对应的反应。
云上的SaaS提供商也想利用这种编程范式，但问题在于云商通常是没有租户的API server的所有权的，所以想管理租户集群内的CR是很难的。
要达到上述目的，通常需要云商直接接入租户的API server或者在租户集群内部部署一个agent，用agent来和云商的API server通信。

# 动机
为了管理租户集群中的CR，目前我们必须打通云商和租户之间的网络链接，从而让他们能访问到对方的API server。
这是既困难，又昂贵且不安全的。
困难的点在于如果云商和租户的VPC处于不同的AWS region，我们就要部署额外的资源如transit gateway来路由跨region的流量。
这些基础设施资源的开销是会随租户数量增长而累积的，而且系统的复杂度也会随之增长。
维护系统，查找问题的难度都会提升。
最后，对于云商和租户来说，把API server暴露给对方都是不理想的，因为这会增大受攻击的窗口。
如果我们能把依赖网络做的信息传递转化为数据驱动的信息传递那就能很好地解决上述问题。

# 解决方案
上述问题的根源在于API server的存储后端(即etcd)和网络基础设施是耦合的。
API server本身是无状态的。
之所以租户和云商不能各自直接访问自己VPC里的API server是因为我们不能把etcd同时延展到双方的VPC里，所以我们需要把双方VPC连接起来才能让他们通信。
为了解决该问题，我们可以把etcd替换成AWS已有的支持跨region的服务如S3，SNS以及SQS。
这样，在云商和租户的VPC中各自将无状态的API server接入上述AWS服务，我们就不需要通过在VPC间打通网络来传递信息了。

# 局限性
这个方法还是有局限性的。
通常情况，Kubernetes网络模型是规定API server要能访问集群中所有节点以及pod的。
我们这种部署模式通常是不满足Kubernetes的网络模型的。
一些子资源(如代理，日志)或者功能(如healthcheck)可能不能正常工作。
这里我们关注的不是做Kubernetes的合规而是专注于解决我们上述的场景中的问题。
